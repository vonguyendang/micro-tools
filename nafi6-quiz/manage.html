<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ng√¢n H√†ng C√¢u H·ªèi</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="quiz-container">
        <header>
            <h1>‚öôÔ∏è Qu·∫£n L√Ω Ng√¢n H√†ng C√¢u H·ªèi</h1>
            <p style="text-align: center; color: #dc3545;">*D·ªØ li·ªáu c√¢u h·ªèi th√™m m·ªõi s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o file add-quiz.json tr√™n server*</p>
        </header>

        <div id="admin-password-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="window.close()">&times;</span>
                <h3>üîê Nh·∫≠p M·∫≠t kh·∫©u Qu·∫£n tr·ªã</h3>
                <label for="adminPasswordInput">M·∫≠t kh·∫©u:</label>
                <input type="password" id="adminPasswordInput" placeholder="B√≠ m·∫≠t..." onkeydown="if(event.key === 'Enter') checkAdminPassword()">
                <p id="password-error" style="color: red; margin-top: 10px;" class="hidden"></p>
                <button class="btn btn-primary" onclick="checkAdminPassword()">Truy C·∫≠p</button>
            </div>
        </div>

        <section id="manage-questions-section" class="hidden">
            <div class="add-question-form-container">
                <h3 id="add-edit-form-title">Th√™m C√¢u H·ªèi M·ªõi</h3>
                <form id="add-question-form">
                    <input type="hidden" id="current-question-id">
                    <div class="form-group">
                        <label for="new-question-text">N·ªôi dung C√¢u h·ªèi:</label>
                        <textarea id="new-question-text" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="new-answer-a">ƒê√°p √°n A:</label>
                        <input type="text" id="new-answer-a" required>
                    </div>
                    <div class="form-group">
                        <label for="new-answer-b">ƒê√°p √°n B:</label>
                        <input type="text" id="new-answer-b" required>
                    </div>
                    <div class="form-group">
                        <label for="new-answer-c">ƒê√°p √°n C:</label>
                        <input type="text" id="new-answer-c" required>
                    </div>
                    <div class="form-group">
                        <label for="new-answer-d">ƒê√°p √°n D:</label>
                        <input type="text" id="new-answer-d" required>
                    </div>
                    <div class="form-group">
                        <label for="correct-answer-key">ƒê√°p √°n ƒê√∫ng (A, B, C, D):</label>
                        <select id="correct-answer-key" required>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" id="save-question-btn">L∆∞u C√¢u H·ªèi</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;">H·ªßy Ch·ªânh S·ª≠a</button>
                </form>
            </div>
            
            <hr>
            
            <h3>Danh s√°ch Ng√¢n H√†ng C√¢u H·ªèi (<span id="total-questions"></span> c√¢u)</h3>
            
            <div class="form-group search-container">
                <input type="text" id="search-input" placeholder="Nh·∫≠p t·ª´ kh√≥a ho·∫∑c ID c√¢u h·ªèi ƒë·ªÉ t√¨m ki·∫øm..." onkeyup="filterQuestions()">
            </div>
            
            <div id="question-bank-list">
            </div>
        </section>
        
    </div>

    <script src="data.js"></script> 
    <script>
        // === KHAI B√ÅO BI·∫æN C·ª§C B·ªò ===
        const ADMIN_PASSWORD = 'Bimat@123';
        const BASE_QUESTION_COUNT = 270; // Gi·∫£ ƒë·ªãnh data.js c√≥ 270 c√¢u h·ªèi
        const ADDED_QUESTIONS_FILE = 'add-quiz.json';
        const SAVE_ENDPOINT = './save-quiz-data.php'; // Endpoint API PHP

        const adminPasswordModal = document.getElementById('admin-password-modal');
        const manageSection = document.getElementById('manage-questions-section');
        const questionBankList = document.getElementById('question-bank-list');
        const addQuestionForm = document.getElementById('add-question-form');
        const addEditFormTitle = document.getElementById('add-edit-form-title');
        const saveQuestionBtn = document.getElementById('save-question-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const searchInput = document.getElementById('search-input');

        let allQuestions = [];  // M·∫£ng t·ªïng h·ª£p
        let addedQuestions = []; // D·ªØ li·ªáu t·ª´ add-quiz.json (ƒë∆∞·ª£c t·∫£i v·ªÅ)
        let isEditing = false; // Tr·∫°ng th√°i: ƒêang ch·ªânh s·ª≠a hay Th√™m m·ªõi

        // === LOGIC T·∫¢I V√Ä G·ªòP D·ªÆ LI·ªÜU ===
        
        /**
         * T·∫£i v√† g·ªôp t·∫•t c·∫£ c√¢u h·ªèi t·ª´ data.js v√† add-quiz.json tr√™n server
         */
        async function loadAndMergeQuestions() {
            // 1. L·∫•y d·ªØ li·ªáu t·ª´ data.js
            allQuestions = [...originalQuestions];

            // 2. L·∫•y d·ªØ li·ªáu t·ª´ file add-quiz.json tr√™n server
            try {
                const response = await fetch(ADDED_QUESTIONS_FILE);
                if (response.ok) {
                    addedQuestions = await response.json();
                    if (Array.isArray(addedQuestions)) {
                        // Lo·∫°i b·ªè c√°c c√¢u h·ªèi tr√πng ID n·∫øu c√≥ l·ªói trong qu√° tr√¨nh merge (ƒë·ªÅ ph√≤ng)
                        const addedIds = new Set(originalQuestions.map(q => q.id));
                        addedQuestions = addedQuestions.filter(q => !addedIds.has(q.id));

                        allQuestions = allQuestions.concat(addedQuestions);
                    }
                } else {
                    // N·∫øu file kh√¥ng t·ªìn t·∫°i ho·∫∑c l·ªói, coi nh∆∞ m·∫£ng r·ªóng
                    addedQuestions = [];
                }
            } catch (e) {
                console.warn(`L·ªói khi fetch file ${ADDED_QUESTIONS_FILE}. S·ª≠ d·ª•ng m·∫£ng r·ªóng cho c√¢u h·ªèi th√™m m·ªõi.`, e);
                addedQuestions = [];
            }
        }

        // === LOGIC L∆ØU D·ªÆ LI·ªÜU L√äN SERVER (S·ª≠ d·ª•ng PHP API) ===
        
        /**
         * Ghi c√¢u h·ªèi ƒë√£ th√™m/s·ª≠a/x√≥a v√†o file add-quiz.json tr√™n server
         * @param {Object} updatedData - M·∫£ng addedQuestions m·ªõi c·∫ßn l∆∞u
         */
        async function saveUpdatedAddedQuestions(updatedData) {
            
            // 1. G·ª≠i y√™u c·∫ßu POST ƒë·∫øn server
            try {
                const response = await fetch(SAVE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`‚úÖ Thao t√°c th√†nh c√¥ng. ${result.message}. Vui l√≤ng t·∫£i l·∫°i trang quiz (index.html) ƒë·ªÉ th·∫•y c·∫≠p nh·∫≠t.`);
                        
                        // C·∫≠p nh·∫≠t client-side 
                        await loadAndMergeQuestions(); // T·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ ƒë·ªìng b·ªô
                        renderQuestionBank();
                        
                        return true;
                    } else {
                         alert(`‚ùå L·ªói Server: Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu. ${result.message}`);
                         return false;
                    }
                } else {
                    const errorText = await response.text();
                    alert(`‚ùå L·ªói Server: Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu. Server tr·∫£ v·ªÅ l·ªói: ${response.status} - ${errorText}`);
                    return false;
                }

            } catch (e) {
                alert("‚ùå L·ªói K·∫øt N·ªëi: Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh endpoint PHP.");
                console.error("L·ªói khi g·ª≠i d·ªØ li·ªáu l√™n server:", e);
                return false;
            }
        }


        // === LOGIC QU·∫¢N L√ù M·∫¨T KH·∫®U ===
        
        window.onload = function() {
            document.getElementById('adminPasswordInput').focus();
        };

        /**
         * Ki·ªÉm tra m·∫≠t kh·∫©u admin
         */
        async function checkAdminPassword() {
            const enteredPassword = document.getElementById('adminPasswordInput').value.trim();
            const errorMessage = document.getElementById('password-error');

            if (enteredPassword === ADMIN_PASSWORD) {
                errorMessage.classList.add('hidden');
                
                // T·∫£i d·ªØ li·ªáu tr∆∞·ªõc khi hi·ªÉn th·ªã trang qu·∫£n l√Ω
                await loadAndMergeQuestions();                     

                adminPasswordModal.classList.add('hidden'); // ·∫®n modal
                manageSection.classList.remove('hidden');    // Hi·ªÉn th·ªã ph·∫ßn qu·∫£n l√Ω
                renderQuestionBank();                         // Hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi
            } else {
                errorMessage.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.';
                errorMessage.classList.remove('hidden');
                document.getElementById('adminPasswordInput').value = ''; 
                document.getElementById('adminPasswordInput').focus();
            }
        }
        
        window.checkAdminPassword = checkAdminPassword; // ƒê∆∞a h√†m ra ph·∫°m vi global

        
        // === H√ÄM HI·ªÇN TH·ªä V√Ä T√åM KI·∫æM NG√ÇN H√ÄNG C√ÇU H·ªéI ===
        
        /**
         * L·ªçc danh s√°ch c√¢u h·ªèi d·ª±a tr√™n t·ª´ kh√≥a t√¨m ki·∫øm
         */
        function filterQuestions() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            let filteredQuestions = allQuestions;

            if (searchTerm) {
                filteredQuestions = allQuestions.filter(q => 
                    q.question.toLowerCase().includes(searchTerm) || 
                    String(q.id) === searchTerm // T√¨m theo ID
                );
            }

            renderQuestionBank(filteredQuestions);
        }
        
        window.filterQuestions = filterQuestions; // ƒê∆∞a h√†m ra ph·∫°m vi global

        /**
         * Hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi (ƒë√£ l·ªçc)
         */
        function renderQuestionBank(questionsToRender = allQuestions) {
            document.getElementById('total-questions').textContent = allQuestions.length;

            if (questionsToRender.length === 0 && searchInput.value.trim()) {
                questionBankList.innerHTML = `<p style="color: #dc3545; text-align: center;">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o kh·ªõp v·ªõi t·ª´ kh√≥a.</p>`;
                return;
            }


            let htmlContent = questionsToRender.map((q, index) => {
                const questionNumber = allQuestions.findIndex(item => item.id === q.id) + 1; // S·ªë th·ª© t·ª± trong m·∫£ng t·ªïng h·ª£p
                
                // X√°c ƒë·ªãnh ngu·ªìn c√¢u h·ªèi
                const isAdded = q.id > BASE_QUESTION_COUNT;
                const sourceTag = isAdded ? ' <span style="color:#17a2b8;">(add-quiz.json)</span>' : ' <span style="color:#495057;">(data.js)</span>';
                
                // T·∫°o danh s√°ch ƒë√°p √°n
                const answerOptions = Object.keys(q.answers).map(key => {
                    const isCorrect = key === q.correctAnswer;
                    const answerText = q.answers[key];
                    return `<div class="q-answer">
                                ${key}. ${answerText} 
                                ${isCorrect ? ' <span class="correct-answer-highlight"> (ƒê√°p √°n ƒë√∫ng ‚úÖ)</span>' : ''}
                            </div>`;
                }).join('');

                // Th√™m n√∫t S·ª≠a v√† X√≥a ch·ªâ cho c√¢u h·ªèi trong add-quiz.json
                const managementButtons = isAdded ? `
                    <div style="margin-top: 10px;">
                        <button class="btn btn-info btn-sm" onclick="openEditModal(${q.id})">S·ª≠a</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteQuestion(${q.id})">X√≥a</button>
                    </div>
                ` : '<div style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">(C√¢u h·ªèi g·ªëc - kh√¥ng th·ªÉ s·ª≠a/x√≥a)</div>';


                return `
                    <div class="question-bank-item" data-question-id="${q.id}">
                        <p class="q-number">C√¢u ${questionNumber} (ID: ${q.id})${sourceTag}:</p>
                        <p class="q-text">${q.question}</p>
                        ${answerOptions}
                        <span class="correct-answer-key">ƒê√ÅP √ÅN: ${q.correctAnswer}</span>
                        ${managementButtons}
                    </div>
                `;
            }).join('');

            questionBankList.innerHTML = htmlContent;
        }

        // === H√ÄM X·ª¨ L√ù S·ª¨A C√ÇU H·ªéI (EDIT) ===

        /**
         * ƒê·∫∑t form v√†o ch·∫ø ƒë·ªô ch·ªânh s·ª≠a v√† ƒëi·ªÅn d·ªØ li·ªáu
         * @param {number} questionId - ID c·ªßa c√¢u h·ªèi c·∫ßn s·ª≠a
         */
        function openEditModal(questionId) {
            const questionToEdit = addedQuestions.find(q => q.id === questionId);
            if (!questionToEdit) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi ƒë·ªÉ s·ª≠a.");
                return;
            }
            
            isEditing = true;
            addEditFormTitle.textContent = "Ch·ªânh S·ª≠a C√¢u H·ªèi (ID: " + questionId + ")";
            saveQuestionBtn.textContent = "C·∫≠p Nh·∫≠t C√¢u H·ªèi";
            cancelEditBtn.style.display = 'inline-block';

            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            document.getElementById('current-question-id').value = questionToEdit.id;
            document.getElementById('new-question-text').value = questionToEdit.question;
            document.getElementById('new-answer-a').value = questionToEdit.answers.A;
            document.getElementById('new-answer-b').value = questionToEdit.answers.B;
            document.getElementById('new-answer-c').value = questionToEdit.answers.C;
            document.getElementById('new-answer-d').value = questionToEdit.answers.D;
            document.getElementById('correct-answer-key').value = questionToEdit.correctAnswer;
            
            // Cu·ªôn l√™n ƒë·∫ßu form ƒë·ªÉ ng∆∞·ªùi d√πng d·ªÖ nh√¨n
            manageSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        window.openEditModal = openEditModal; // ƒê∆∞a h√†m ra ph·∫°m vi global

        /**
         * H·ªßy ch·∫ø ƒë·ªô ch·ªânh s·ª≠a v√† ƒë∆∞a form v·ªÅ tr·∫°ng th√°i th√™m m·ªõi
         */
        function cancelEdit() {
            isEditing = false;
            addEditFormTitle.textContent = "Th√™m C√¢u H·ªèi M·ªõi";
            saveQuestionBtn.textContent = "L∆∞u C√¢u H·ªèi";
            cancelEditBtn.style.display = 'none';
            addQuestionForm.reset();
        }

        cancelEditBtn.addEventListener('click', cancelEdit);


        // === H√ÄM X·ª¨ L√ù X√ìA C√ÇU H·ªéI (DELETE) ===

        /**
         * X√≥a c√¢u h·ªèi kh·ªèi danh s√°ch v√† l∆∞u l√™n server
         * @param {number} questionId - ID c·ªßa c√¢u h·ªèi c·∫ßn x√≥a
         */
        async function deleteQuestion(questionId) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi (ID: ${questionId}) n√†y kh√¥ng? Thao t√°c n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u l√™n server.`)) {
                return;
            }

            // L·ªçc ra c√¢u h·ªèi c·∫ßn x√≥a kh·ªèi m·∫£ng addedQuestions
            const updatedAddedQuestions = addedQuestions.filter(q => q.id !== questionId);

            const success = await saveUpdatedAddedQuestions(updatedAddedQuestions);
            
            if (success) {
                alert(`‚úÖ ƒê√£ x√≥a c√¢u h·ªèi (ID: ${questionId}) th√†nh c√¥ng.`);
            }
        }

        window.deleteQuestion = deleteQuestion; // ƒê∆∞a h√†m ra ph·∫°m vi global


        // === H√ÄM X·ª¨ L√ù SUBMIT FORM (TH√äM M·ªöI & C·∫¨P NH·∫¨T) ===

        addQuestionForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const currentQuestionId = parseInt(document.getElementById('current-question-id').value) || 0;
            const newQuestionData = {
                question: document.getElementById('new-question-text').value.trim().replace(/\n/g, ' '), 
                answers: {
                    A: document.getElementById('new-answer-a').value.trim(),
                    B: document.getElementById('new-answer-b').value.trim(),
                    C: document.getElementById('new-answer-c').value.trim(),
                    D: document.getElementById('new-answer-d').value.trim(),
                },
                correctAnswer: document.getElementById('correct-answer-key').value,
            };

            let updatedAddedQuestions = [...addedQuestions];
            let success = false;
            let actionMessage = '';

            if (isEditing && currentQuestionId) {
                // CH·∫æ ƒê·ªò CH·ªàNH S·ª¨A (EDIT)
                const index = updatedAddedQuestions.findIndex(q => q.id === currentQuestionId);
                if (index !== -1) {
                    updatedAddedQuestions[index] = { ...updatedAddedQuestions[index], ...newQuestionData };
                    actionMessage = `Ch·ªânh s·ª≠a c√¢u h·ªèi ID: ${currentQuestionId}`;
                }
            } else {
                // CH·∫æ ƒê·ªò TH√äM M·ªöI (ADD)
                const maxId = allQuestions.length > 0 ? allQuestions.reduce((max, q) => Math.max(max, q.id), 0) : BASE_QUESTION_COUNT;
                const newId = maxId + 1; 
                
                const newQuestion = { id: newId, ...newQuestionData };
                updatedAddedQuestions.push(newQuestion);
                actionMessage = `Th√™m c√¢u h·ªèi m·ªõi ID: ${newId}`;
            }

            // L∆∞u l√™n server
            success = await saveUpdatedAddedQuestions(updatedAddedQuestions);
            
            if (success) {
                alert(`‚úÖ ${actionMessage} th√†nh c√¥ng!`);
                cancelEdit(); // Reset form v√† tr·∫°ng th√°i
            }
        });
        
    </script>
</body>
</html>